# å·¥ä½œæµå¤±è´¥é€šçŸ¥
# ç›‘å¬å…¶ä»–å·¥ä½œæµçš„å®Œæˆäº‹ä»¶ï¼Œåœ¨å¤±è´¥æ—¶å‘é€é€šçŸ¥

name: Notify on Failure

on:
  workflow_run:
    workflows:
      - CI
      - Lint
      - PR Check
      - Security Audit
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    # åªåœ¨å·¥ä½œæµå¤±è´¥æ—¶è¿è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: è·å–å¤±è´¥ä¿¡æ¯
        id: failure_info
        run: |
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "workflow_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
          echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          echo "commit_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT
          echo "actor=${{ github.event.workflow_run.actor.login }}" >> $GITHUB_OUTPUT
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT

      - name: è¾“å‡ºå¤±è´¥æ‘˜è¦
        run: |
          echo "## ğŸš¨ å·¥ä½œæµå¤±è´¥é€šçŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å­—æ®µ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| å·¥ä½œæµ | ${{ steps.failure_info.outputs.workflow_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åˆ†æ”¯ | ${{ steps.failure_info.outputs.branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æäº¤ | \`${{ steps.failure_info.outputs.commit_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘è€… | @${{ steps.failure_info.outputs.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é“¾æ¥ | [æŸ¥çœ‹è¯¦æƒ…](${{ steps.failure_info.outputs.workflow_url }}) |" >> $GITHUB_STEP_SUMMARY

      # Slack é€šçŸ¥ï¼ˆå¯é€‰ï¼Œéœ€è¦é…ç½® SLACK_WEBHOOK_URL secretï¼‰
      - name: Slack é€šçŸ¥
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš¨ CI å·¥ä½œæµå¤±è´¥",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*å·¥ä½œæµ:*\n${{ steps.failure_info.outputs.workflow_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*åˆ†æ”¯:*\n${{ steps.failure_info.outputs.branch }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ä»“åº“:*\n${{ steps.failure_info.outputs.repo }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*è§¦å‘è€…:*\n${{ steps.failure_info.outputs.actor }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹å¤±è´¥è¯¦æƒ…"
                      },
                      "url": "${{ steps.failure_info.outputs.workflow_url }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      # æ£€æŸ¥æ˜¯å¦ä¸ºæŒç»­å¤±è´¥ï¼ˆå¯é€‰ï¼Œç”¨äºåˆ›å»º Issueï¼‰
      - name: æ£€å‡ºä»£ç 
        if: ${{ vars.CREATE_ISSUE_ON_FAILURE == 'true' }}
        uses: actions/checkout@v6

      - name: æ£€æŸ¥è¿‘æœŸå¤±è´¥æ¬¡æ•°
        if: ${{ vars.CREATE_ISSUE_ON_FAILURE == 'true' }}
        id: check_failures
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '${{ github.event.workflow_run.workflow_id }}',
              branch: '${{ steps.failure_info.outputs.branch }}',
              per_page: 5
            });

            const recentFailures = runs.workflow_runs.filter(
              run => run.conclusion === 'failure'
            ).length;

            console.log(`è¿‘æœŸ 5 æ¬¡è¿è¡Œä¸­æœ‰ ${recentFailures} æ¬¡å¤±è´¥`);
            core.setOutput('recent_failures', recentFailures);
            core.setOutput('should_create_issue', recentFailures >= 3);

      - name: åˆ›å»º GitHub Issueï¼ˆæŒç»­å¤±è´¥ï¼‰
        if: ${{ vars.CREATE_ISSUE_ON_FAILURE == 'true' && steps.check_failures.outputs.should_create_issue == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸å…³ Issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure,automated'
            });

            const workflowName = '${{ steps.failure_info.outputs.workflow_name }}';
            const branch = '${{ steps.failure_info.outputs.branch }}';
            const existingIssue = issues.find(
              issue => issue.title.includes(workflowName) && issue.title.includes(branch)
            );

            if (existingIssue) {
              // æ›´æ–°ç°æœ‰ Issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ğŸ”„ åˆä¸€æ¬¡å¤±è´¥\n\n` +
                      `- **è¿è¡Œé“¾æ¥**: ${{ steps.failure_info.outputs.workflow_url }}\n` +
                      `- **æäº¤**: \`${{ steps.failure_info.outputs.commit_sha }}\`\n` +
                      `- **æ—¶é—´**: ${new Date().toISOString()}\n`
              });
              console.log(`å·²æ›´æ–° Issue #${existingIssue.number}`);
            } else {
              // åˆ›å»ºæ–° Issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ CI æŒç»­å¤±è´¥: ${workflowName} on ${branch}`,
                body: `## å·¥ä½œæµæŒç»­å¤±è´¥è­¦å‘Š\n\n` +
                      `**${workflowName}** å·¥ä½œæµåœ¨ **${branch}** åˆ†æ”¯ä¸Šè¿ç»­å¤±è´¥ 3 æ¬¡ä»¥ä¸Šã€‚\n\n` +
                      `### å¤±è´¥ä¿¡æ¯\n\n` +
                      `| å­—æ®µ | å€¼ |\n` +
                      `|------|-----|\n` +
                      `| å·¥ä½œæµ | ${workflowName} |\n` +
                      `| åˆ†æ”¯ | ${branch} |\n` +
                      `| æœ€è¿‘å¤±è´¥ | ${{ steps.failure_info.outputs.workflow_url }} |\n` +
                      `| æäº¤ | \`${{ steps.failure_info.outputs.commit_sha }}\` |\n` +
                      `| è§¦å‘è€… | @${{ steps.failure_info.outputs.actor }} |\n\n` +
                      `### å»ºè®®æ“ä½œ\n\n` +
                      `1. æŸ¥çœ‹ [å¤±è´¥æ—¥å¿—](${{ steps.failure_info.outputs.workflow_url }})\n` +
                      `2. æ£€æŸ¥æœ€è¿‘çš„ä»£ç å˜æ›´\n` +
                      `3. ä¿®å¤é—®é¢˜åå…³é—­æ­¤ Issue\n\n` +
                      `---\n` +
                      `*æ­¤ Issue ç”± CI è‡ªåŠ¨åˆ›å»º*`,
                labels: ['ci-failure', 'automated', 'bug']
              });
              console.log(`å·²åˆ›å»º Issue #${newIssue.number}`);
            }

  # æˆåŠŸæ¢å¤é€šçŸ¥ï¼ˆå…³é—­ç›¸å…³ Issueï¼‰
  notify-recovery:
    runs-on: ubuntu-latest
    # åªåœ¨å·¥ä½œæµæˆåŠŸæ—¶è¿è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' && vars.CREATE_ISSUE_ON_FAILURE == 'true' }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6

      - name: å…³é—­æ¢å¤çš„ Issue
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ github.event.workflow_run.name }}';
            const branch = '${{ github.event.workflow_run.head_branch }}';

            // æŸ¥æ‰¾ç›¸å…³çš„å¤±è´¥ Issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure,automated'
            });

            const relatedIssue = issues.find(
              issue => issue.title.includes(workflowName) && issue.title.includes(branch)
            );

            if (relatedIssue) {
              // æ·»åŠ æ¢å¤è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: relatedIssue.number,
                body: `## âœ… CI å·²æ¢å¤\n\n` +
                      `**${workflowName}** å·¥ä½œæµåœ¨ **${branch}** åˆ†æ”¯ä¸Šå·²æ¢å¤æ­£å¸¸ã€‚\n\n` +
                      `- **æˆåŠŸè¿è¡Œ**: ${{ github.event.workflow_run.html_url }}\n` +
                      `- **æäº¤**: \`${{ github.event.workflow_run.head_sha }}\`\n\n` +
                      `è‡ªåŠ¨å…³é—­æ­¤ Issueã€‚`
              });

              // å…³é—­ Issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: relatedIssue.number,
                state: 'closed',
                state_reason: 'completed'
              });

              console.log(`å·²å…³é—­ Issue #${relatedIssue.number}`);
            }
