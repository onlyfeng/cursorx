# Cursor CLI è‡ªåŠ¨ä»£ç å®¡æŸ¥å·¥ä½œæµ
# å‚è€ƒ: https://cursor.com/cn/docs/cli/cookbook/code-review
#
# ä½¿ç”¨å‰è¯·ç¡®ä¿:
# 1. åœ¨ä»“åº“ Settings > Secrets ä¸­è®¾ç½® CURSOR_API_KEY
# 2. ç¡®ä¿ GitHub Token æœ‰è¶³å¤Ÿçš„æƒé™

name: ä»£ç å®¡æŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write
  contents: read
  issues: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ä¾èµ–æ£€æŸ¥ Job
  dependency-check:
    runs-on: ubuntu-latest
    name: ä¾èµ–ç‰ˆæœ¬æ£€æŸ¥

    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v6

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.in
            requirements-test.in

      - name: å®‰è£… pip-tools
        run: pip install --upgrade pip pip-tools

      - name: ä½¿ç”¨ pip-sync å®‰è£…é”å®šä¾èµ–
        run: |
          # ä½¿ç”¨ pip-sync ç¡®ä¿ç¯å¢ƒä¸ requirements.txt å®Œå…¨ä¸€è‡´
          pip-sync requirements.txt

      - name: éªŒè¯ä¾èµ–å®‰è£…
        run: |
          # æ£€æŸ¥ä¾èµ–ä¸€è‡´æ€§
          pip check
          # éªŒè¯å…³é”®åŒ…å·²å®‰è£…
          python -c "import pydantic; import loguru; print('æ ¸å¿ƒä¾èµ–éªŒè¯é€šè¿‡')"

      - name: è¿è¡Œä¾èµ–æ£€æŸ¥
        id: deps_check
        run: |
          python scripts/check_deps.py --format json --output deps-report.json --ci || echo "has_errors=true" >> $GITHUB_OUTPUT
          python scripts/check_deps.py --format md --output deps-report.md --ci

      - name: ä¸Šä¼ ä¾èµ–æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: |
            deps-report.json
            deps-report.md

      - name: è¯„è®º PRï¼ˆå¦‚æœ‰é—®é¢˜ï¼‰
        if: steps.deps_check.outputs.has_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('deps-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ğŸ” ä¾èµ–æ£€æŸ¥æŠ¥å‘Š\n\n' + report
            });

  code-review:
    runs-on: ubuntu-latest
    needs: dependency-check
    # è·³è¿‡è‰ç¨¿ PR çš„è‡ªåŠ¨ä»£ç å®¡æŸ¥
    if: github.event.pull_request.draft == false

    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: å®‰è£… Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: é…ç½® git èº«ä»½ä¿¡æ¯
        run: |
          git config user.name "Cursor Agent"
          git config user.email "cursoragent@cursor.com"

      - name: æ‰§è¡Œè‡ªåŠ¨ä»£ç å®¡æŸ¥
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          MODEL: gpt-5
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BLOCKING_REVIEW: ${{ vars.BLOCKING_REVIEW || 'false' }}
        run: |
          agent --force --model "$MODEL" --output-format=text --print 'æ‚¨æ­£åœ¨ GitHub Actions è¿è¡Œå™¨ä¸­æ‰§è¡Œè‡ªåŠ¨ä»£ç å®¡æŸ¥ã€‚gh å‘½ä»¤è¡Œç•Œé¢å¯ç”¨å¹¶é€šè¿‡ GH_TOKEN è¿›è¡Œèº«ä»½éªŒè¯ã€‚æ‚¨å¯ä»¥å¯¹æ‹‰å–è¯·æ±‚è¿›è¡Œè¯„è®ºã€‚

          ä¸Šä¸‹æ–‡ï¼š
          - ä»“åº“ï¼š${{ github.repository }}
          - PR ç¼–å·ï¼š${{ github.event.pull_request.number }}
          - PR Head SHAï¼š${{ github.event.pull_request.head.sha }}
          - PR Base SHAï¼š${{ github.event.pull_request.base.sha }}
          - é˜»å¡å®¡æŸ¥ï¼š${{ env.BLOCKING_REVIEW }}

          ç›®æ ‡ï¼š
          1) é‡æ–°æ£€æŸ¥ç°æœ‰å®¡æŸ¥è¯„è®ºï¼Œå¹¶åœ¨é—®é¢˜è§£å†³åå›å¤å·²è§£å†³ã€‚
          2) å®¡æŸ¥å½“å‰ PR å·®å¼‚ï¼Œä»…æ ‡è®°æ˜ç¡®çš„é«˜ä¸¥é‡æ€§é—®é¢˜ã€‚
          3) ä»…åœ¨æ›´æ”¹çš„è¡Œä¸Šç•™ä¸‹éå¸¸ç®€çŸ­çš„å†…è”è¯„è®ºï¼ˆ1-2 å¥è¯ï¼‰ï¼Œå¹¶åœ¨æœ€åæä¾›ç®€è¦æ€»ç»“ã€‚

          æµç¨‹ï¼š
          - è·å–ç°æœ‰è¯„è®ºï¼šgh pr view --json comments
          - è·å–å·®å¼‚ï¼šgh pr diff
          - è·å–å¸¦æœ‰è¡¥ä¸çš„æ›´æ”¹æ–‡ä»¶ï¼šgh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files --paginate --jq ".[] | {filename,patch}"

          ä»…åˆ†æä»¥ä¸‹é—®é¢˜ï¼š
          - ç©ºå€¼/æœªå®šä¹‰è§£å¼•ç”¨
          - èµ„æºæ³„æ¼ï¼ˆæœªå…³é—­çš„æ–‡ä»¶æˆ–è¿æ¥ï¼‰
          - æ³¨å…¥æ”»å‡»ï¼ˆSQL/XSSï¼‰
          - å¹¶å‘/ç«æ€æ¡ä»¶
          - å…³é”®æ“ä½œç¼ºå°‘é”™è¯¯å¤„ç†
          - å…·æœ‰ä¸æ­£ç¡®è¡Œä¸ºçš„æ˜æ˜¾é€»è¾‘é”™è¯¯
          - æ˜ç¡®çš„å®‰å…¨æ¼æ´

          é¿å…é‡å¤ï¼šå¦‚æœç›¸åŒæˆ–ç›¸è¿‘è¡Œä¸Šå·²å­˜åœ¨ç±»ä¼¼åé¦ˆï¼Œåˆ™è·³è¿‡ã€‚'
