# PR 检查工作流
# 仅在 Pull Request 事件时运行全面检查

name: PR Check

on:
  pull_request:
    branches:
      - main
      - master
    types:
      - opened
      - synchronize
      - reopened
      - edited

jobs:
  # 重用 CI 工作流的测试结果
  ci-tests:
    name: CI 测试
    uses: ./.github/workflows/ci.yml

  # 重用 Lint 工作流的检查结果
  lint-checks:
    name: Lint 检查
    uses: ./.github/workflows/lint.yml

  # 运行完整的项目健康检查
  full-check:
    name: 完整项目检查
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 ruff mypy pytest

      - name: 运行 check_all.sh --full
        id: check_all
        run: |
          chmod +x scripts/check_all.sh
          # 捕获输出用于摘要
          set +e
          OUTPUT=$(bash scripts/check_all.sh --full 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "$OUTPUT"
          
          # 保存输出到文件供后续使用
          echo "$OUTPUT" > /tmp/check_all_output.txt
          
          # 提取统计信息
          PASS_COUNT=$(echo "$OUTPUT" | grep -oP '✓ 通过:\s*\K\d+' || echo "0")
          FAIL_COUNT=$(echo "$OUTPUT" | grep -oP '✗ 失败:\s*\K\d+' || echo "0")
          WARN_COUNT=$(echo "$OUTPUT" | grep -oP '⚠ 警告:\s*\K\d+' || echo "0")
          
          echo "pass_count=$PASS_COUNT" >> $GITHUB_OUTPUT
          echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
          echo "warn_count=$WARN_COUNT" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          exit $EXIT_CODE

  # 代码格式检查
  format-check:
    name: 代码格式检查
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 安装格式化工具
        run: |
          pip install ruff black isort

      - name: 检查 ruff 格式
        id: ruff_format
        run: |
          echo "=== Ruff 格式检查 ==="
          set +e
          ruff format --check . 2>&1
          RUFF_EXIT=$?
          set -e
          
          if [ $RUFF_EXIT -ne 0 ]; then
            echo "has_unformatted=true" >> $GITHUB_OUTPUT
            echo "::warning::发现未格式化的代码，请运行 'ruff format .' 修复"
          else
            echo "has_unformatted=false" >> $GITHUB_OUTPUT
            echo "代码格式检查通过"
          fi
          
          # 不阻止 PR，只是警告
          exit 0

      - name: 检查 import 排序
        id: isort_check
        run: |
          echo "=== Import 排序检查 ==="
          set +e
          isort --check-only --diff . 2>&1
          ISORT_EXIT=$?
          set -e
          
          if [ $ISORT_EXIT -ne 0 ]; then
            echo "imports_unsorted=true" >> $GITHUB_OUTPUT
            echo "::warning::Import 排序不正确，请运行 'isort .' 修复"
          else
            echo "imports_unsorted=false" >> $GITHUB_OUTPUT
            echo "Import 排序检查通过"
          fi
          
          exit 0

  # PR 描述格式验证
  pr-description:
    name: PR 描述格式验证
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 验证 PR 描述
        id: validate_pr
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "=== 验证 PR 描述格式 ==="
          
          ERRORS=()
          WARNINGS=()
          
          # 检查标题是否为空
          if [ -z "$PR_TITLE" ]; then
            ERRORS+=("PR 标题不能为空")
          fi
          
          # 检查标题长度
          TITLE_LEN=${#PR_TITLE}
          if [ $TITLE_LEN -gt 100 ]; then
            WARNINGS+=("PR 标题过长 ($TITLE_LEN 字符，建议 <= 100)")
          fi
          
          # 检查描述是否为空
          if [ -z "$PR_BODY" ]; then
            WARNINGS+=("PR 描述为空，建议添加描述说明")
          else
            # 检查描述是否包含关键部分
            BODY_LEN=${#PR_BODY}
            
            if [ $BODY_LEN -lt 20 ]; then
              WARNINGS+=("PR 描述过短 ($BODY_LEN 字符)，建议添加更多说明")
            fi
            
            # 检查是否包含 Summary 或 摘要 部分
            if echo "$PR_BODY" | grep -qiE '(##\s*(summary|摘要|概述|变更说明))'; then
              echo "✓ PR 描述包含摘要部分"
            else
              WARNINGS+=("建议在 PR 描述中添加 '## Summary' 或 '## 摘要' 部分")
            fi
            
            # 检查是否包含 Test Plan 或 测试计划
            if echo "$PR_BODY" | grep -qiE '(##\s*(test\s*plan|测试计划|测试方案))'; then
              echo "✓ PR 描述包含测试计划"
            else
              WARNINGS+=("建议在 PR 描述中添加 '## Test plan' 或 '## 测试计划' 部分")
            fi
          fi
          
          # 输出结果
          echo ""
          echo "=== 验证结果 ==="
          
          if [ ${#ERRORS[@]} -gt 0 ]; then
            echo "错误:"
            for err in "${ERRORS[@]}"; do
              echo "  ✗ $err"
              echo "::error::$err"
            done
          fi
          
          if [ ${#WARNINGS[@]} -gt 0 ]; then
            echo "警告:"
            for warn in "${WARNINGS[@]}"; do
              echo "  ⚠ $warn"
              echo "::warning::$warn"
            done
          fi
          
          if [ ${#ERRORS[@]} -eq 0 ] && [ ${#WARNINGS[@]} -eq 0 ]; then
            echo "✓ PR 描述格式良好"
          fi
          
          echo "error_count=${#ERRORS[@]}" >> $GITHUB_OUTPUT
          echo "warning_count=${#WARNINGS[@]}" >> $GITHUB_OUTPUT
          
          # 只有错误时才失败
          if [ ${#ERRORS[@]} -gt 0 ]; then
            exit 1
          fi

  # 检查摘要
  summary:
    name: 检查摘要
    runs-on: ubuntu-latest
    needs: [full-check, format-check, pr-description]
    if: always()
    steps:
      - name: 生成检查摘要
        env:
          FULL_CHECK_RESULT: ${{ needs.full-check.result }}
          FORMAT_CHECK_RESULT: ${{ needs.format-check.result }}
          PR_DESC_RESULT: ${{ needs.pr-description.result }}
        run: |
          echo "# PR 检查摘要" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 检查项 | 结果 |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          # 完整检查结果
          if [ "$FULL_CHECK_RESULT" = "success" ]; then
            echo "| 完整项目检查 | ✅ 通过 |" >> $GITHUB_STEP_SUMMARY
          elif [ "$FULL_CHECK_RESULT" = "failure" ]; then
            echo "| 完整项目检查 | ❌ 失败 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 完整项目检查 | ⚠️ $FULL_CHECK_RESULT |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # 格式检查结果
          if [ "$FORMAT_CHECK_RESULT" = "success" ]; then
            echo "| 代码格式检查 | ✅ 通过 |" >> $GITHUB_STEP_SUMMARY
          elif [ "$FORMAT_CHECK_RESULT" = "failure" ]; then
            echo "| 代码格式检查 | ❌ 失败 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 代码格式检查 | ⚠️ $FORMAT_CHECK_RESULT |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # PR 描述验证结果
          if [ "$PR_DESC_RESULT" = "success" ]; then
            echo "| PR 描述格式 | ✅ 通过 |" >> $GITHUB_STEP_SUMMARY
          elif [ "$PR_DESC_RESULT" = "failure" ]; then
            echo "| PR 描述格式 | ❌ 失败 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| PR 描述格式 | ⚠️ $PR_DESC_RESULT |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # 总体结果
          if [ "$FULL_CHECK_RESULT" = "success" ] && [ "$PR_DESC_RESULT" = "success" ]; then
            echo "## ✅ 所有必要检查通过" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ 部分检查未通过，请查看详情" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 提示" >> $GITHUB_STEP_SUMMARY
          echo "- 运行 \`bash scripts/check_all.sh --full\` 本地检查" >> $GITHUB_STEP_SUMMARY
          echo "- 运行 \`ruff format .\` 自动格式化代码" >> $GITHUB_STEP_SUMMARY
          echo "- 运行 \`isort .\` 自动排序 imports" >> $GITHUB_STEP_SUMMARY

      - name: 检查是否应该失败
        env:
          FULL_CHECK_RESULT: ${{ needs.full-check.result }}
          PR_DESC_RESULT: ${{ needs.pr-description.result }}
        run: |
          # 完整检查和 PR 描述是必须通过的
          if [ "$FULL_CHECK_RESULT" = "failure" ] || [ "$PR_DESC_RESULT" = "failure" ]; then
            echo "必要检查未通过"
            exit 1
          fi
          echo "所有必要检查通过"
