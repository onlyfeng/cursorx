# CI å·¥ä½œæµ
# åœ¨ push å’Œ PR äº‹ä»¶æ—¶è¿è¡Œæµ‹è¯•å’Œæ£€æŸ¥

name: CI

on:
  push:
    branches:
      - main
      - master
      - 'feature/**'
      - 'fix/**'
  pull_request:
    branches:
      - main
      - master
  workflow_call:
    # å…è®¸è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨

permissions:
  contents: read
  pull-requests: write

jobs:
  # æ£€æµ‹æ–‡ä»¶å˜æ›´
  changes:
    runs-on: ubuntu-latest
    outputs:
      deps: ${{ steps.filter.outputs.deps }}
      deps_files: ${{ steps.filter.outputs.deps_files }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æµ‹ä¾èµ–æ–‡ä»¶å˜æ›´
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            deps:
              - 'requirements*.txt'
              - 'requirements*.in'
              - 'pyproject.toml'
              - 'setup.py'
              - 'setup.cfg'
          list-files: shell

  # ä¾èµ–å˜æ›´æ£€æŸ¥
  dependency-check:
    needs: changes
    if: needs.changes.outputs.deps == 'true'
    runs-on: ubuntu-latest
    outputs:
      pip_check_result: ${{ steps.pip_check.outputs.result }}
      pip_audit_result: ${{ steps.pip_audit.outputs.result }}
      import_test_result: ${{ steps.import_test.outputs.result }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit>=2.6.0
          pip install -r requirements.txt

      - name: è¿è¡Œ pip check
        id: pip_check
        run: |
          echo "## pip check ç»“æœ" >> $GITHUB_STEP_SUMMARY
          set +e
          OUTPUT=$(pip check 2>&1)
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: è¿è¡Œ pip-audit
        id: pip_audit
        run: |
          echo "## pip-audit å®‰å…¨æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          set +e
          OUTPUT=$(pip-audit --strict --desc on 2>&1)
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… æœªå‘ç°å·²çŸ¥å®‰å…¨æ¼æ´" >> $GITHUB_STEP_SUMMARY
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ å‘ç°æ½œåœ¨å®‰å…¨é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "result=warning" >> $GITHUB_OUTPUT
            # å¯¹äºéé«˜å±æ¼æ´ï¼Œä»…è­¦å‘Šä¸å¤±è´¥
            if echo "$OUTPUT" | grep -iE "(high|critical)"; then
              echo "result=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
        continue-on-error: true

      - name: å®Œæ•´å¯¼å…¥æµ‹è¯•
        id: import_test
        run: |
          echo "## å®Œæ•´æ¨¡å—å¯¼å…¥æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          set +e
          OUTPUT=$(python scripts/pre_commit_check.py --json 2>&1)
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… æ‰€æœ‰æ¨¡å—å¯¼å…¥æµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            PASSED_COUNT=$(echo "$OUTPUT" | python -c "import sys, json; d=json.load(sys.stdin); print(d.get('passed_count', 0))" 2>/dev/null || echo "N/A")
            echo "- é€šè¿‡æ£€æŸ¥é¡¹: $PASSED_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ¨¡å—å¯¼å…¥æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ä¿å­˜æ£€æŸ¥ç»“æœ
        if: always()
        run: |
          echo "PIP_CHECK=${{ steps.pip_check.outputs.result }}" >> $GITHUB_ENV
          echo "PIP_AUDIT=${{ steps.pip_audit.outputs.result }}" >> $GITHUB_ENV
          echo "IMPORT_TEST=${{ steps.import_test.outputs.result }}" >> $GITHUB_ENV

  # PR ä¾èµ–å˜æ›´è¯„è®º
  dependency-comment:
    needs: [changes, dependency-check]
    if: github.event_name == 'pull_request' && needs.changes.outputs.deps == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: å‘è¡¨ä¾èµ–å˜æ›´è¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const pipCheck = '${{ needs.dependency-check.outputs.pip_check_result }}';
            const pipAudit = '${{ needs.dependency-check.outputs.pip_audit_result }}';
            const importTest = '${{ needs.dependency-check.outputs.import_test_result }}';
            
            const statusIcon = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'warning') return 'âš ï¸';
              return 'âŒ';
            };
            
            const body = `## ğŸ“¦ ä¾èµ–å˜æ›´æ£€æŸ¥æŠ¥å‘Š
            
            æ£€æµ‹åˆ°ä¾èµ–æ–‡ä»¶å˜æ›´ï¼Œå·²æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š
            
            | æ£€æŸ¥é¡¹ | çŠ¶æ€ |
            |--------|------|
            | pip check (ä¾èµ–å®Œæ•´æ€§) | ${statusIcon(pipCheck)} ${pipCheck || 'N/A'} |
            | pip-audit (å®‰å…¨æ¼æ´) | ${statusIcon(pipAudit)} ${pipAudit || 'N/A'} |
            | æ¨¡å—å¯¼å…¥æµ‹è¯• | ${statusIcon(importTest)} ${importTest || 'N/A'} |
            
            > è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ [workflow è¿è¡Œæ—¥å¿—](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})
            `;
            
            // æŸ¥æ‰¾å·²æœ‰è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ“¦ ä¾èµ–å˜æ›´æ£€æŸ¥æŠ¥å‘Š')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        exclude:
          # Windows + Python 3.9 å¯é€‰æ’é™¤ï¼ˆå‡å°‘è¿è¡Œæ—¶é—´ï¼‰
          - os: windows-latest
            python-version: '3.9'
          # macOS + Python 3.9 å¯é€‰æ’é™¤ï¼ˆå‡å°‘è¿è¡Œæ—¶é—´ï¼‰
          - os: macos-latest
            python-version: '3.9'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # Python ç¯å¢ƒè®¾ç½® (éµå¾ª reusable-python-setup.yml æ ‡å‡†)
      - name: è®¾ç½® Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.in
            requirements-test.in

      - name: å®‰è£… pip-tools
        run: python -m pip install --upgrade pip pip-tools

      - name: ä½¿ç”¨ pip-sync å®‰è£…ä¾èµ–
        run: pip-sync requirements.txt

      - name: å®‰è£…æµ‹è¯•å·¥å…·
        run: pip install pytest-timeout

      - name: éªŒè¯ä¾èµ–å®‰è£…
        run: |
          # pip check å¯èƒ½åœ¨æŸäº›å¹³å°ä¸Šå›  torch å…¼å®¹æ€§é—®é¢˜å¤±è´¥
          # macOS ARM ä¸Š torch å¯èƒ½æŠ¥å‘Šä¸å…¼å®¹ï¼Œä½†å®é™…å¯ç”¨
          pip check || echo "âš ï¸ pip check æœ‰è­¦å‘Šï¼ˆå¯èƒ½æ˜¯å¹³å°å…¼å®¹æ€§é—®é¢˜ï¼‰"
        continue-on-error: ${{ runner.os == 'macOS' }}

      - name: Python è¯­æ³•æ£€æŸ¥
        shell: bash
        run: |
          # æ£€æŸ¥æ‰€æœ‰ Python æ–‡ä»¶çš„è¯­æ³•ï¼ˆè·¨å¹³å°å…¼å®¹ï¼‰
          python -c "
          import os
          import py_compile
          import sys

          errors = []
          for root, dirs, files in os.walk('.'):
              # è·³è¿‡ä¸éœ€è¦æ£€æŸ¥çš„ç›®å½•
              dirs[:] = [d for d in dirs if d not in {'.git', 'venv', '__pycache__', '.venv', 'node_modules'}]
              for f in files:
                  if f.endswith('.py'):
                      path = os.path.join(root, f)
                      try:
                          py_compile.compile(path, doraise=True)
                      except py_compile.PyCompileError as e:
                          errors.append(str(e))

          if errors:
              for e in errors:
                  print(e, file=sys.stderr)
              sys.exit(1)
          print('è¯­æ³•æ£€æŸ¥é€šè¿‡')
          "

      - name: æ¨¡å—å¯¼å…¥æ£€æŸ¥
        id: import_check
        run: |
          # è¿è¡Œå¿«é€Ÿå¯¼å…¥æ£€æŸ¥å¹¶æ•è· JSON è¾“å‡º
          set +e
          OUTPUT=$(python scripts/pre_commit_check.py --quick --json 2>&1)
          EXIT_CODE=$?
          set -e
          
          # ä¿å­˜è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
          echo "IMPORT_CHECK_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$OUTPUT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          # è¾“å‡ºåˆ° GITHUB_STEP_SUMMARY
          echo "## æ¨¡å—å¯¼å…¥æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… **æ‰€æœ‰æ¨¡å—å¯¼å…¥æ£€æŸ¥é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
            # è§£æ JSON è¾“å‡ºæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            PASSED_COUNT=$(echo "$OUTPUT" | python -c "import sys, json; d=json.load(sys.stdin); print(d.get('passed_count', 0))" 2>/dev/null || echo "N/A")
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- é€šè¿‡æ£€æŸ¥é¡¹: $PASSED_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æ¨¡å—å¯¼å…¥æ£€æŸ¥å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆå«è¦†ç›–ç‡ï¼‰
        run: |
          pytest tests/ -v --tb=short --color=yes \
            -m "not e2e and not slow and not integration" \
            --cov=. --cov-report=xml --cov-report=term-missing \
            --cov-report=html:htmlcov \
            --cov-fail-under=0 \
            --timeout=60

      - name: Validate run modes
        run: |
          echo "## run.py è¿è¡Œæ¨¡å¼éªŒè¯" >> $GITHUB_STEP_SUMMARY
          
          # éªŒè¯ --help å‚æ•°
          echo "éªŒè¯ run.py --help..."
          python run.py --help || { echo "âŒ run.py --help å¤±è´¥" >> $GITHUB_STEP_SUMMARY; exit 1; }
          echo "âœ… run.py --help é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          
          # å®šä¹‰æ‰€æœ‰è¿è¡Œæ¨¡å¼
          MODES="basic mp knowledge iterate auto plan ask"
          
          # å¾ªç¯éªŒè¯æ¯ä¸ªæ¨¡å¼
          FAILED=0
          for mode in $MODES; do
            echo "éªŒè¯ --mode $mode..."
            if python run.py --mode "$mode" --help; then
              echo "âœ… --mode $mode é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ --mode $mode å¤±è´¥" >> $GITHUB_STEP_SUMMARY
              FAILED=1
            fi
          done
          
          # å¦‚æœä»»ä½•æ¨¡å¼éªŒè¯å¤±è´¥ï¼Œé€€å‡º
          if [ $FAILED -eq 1 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **è¿è¡Œæ¨¡å¼éªŒè¯å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **æ‰€æœ‰è¿è¡Œæ¨¡å¼éªŒè¯é€šè¿‡**" >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ° Codecov
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: ä¸Šä¼  HTML è¦†ç›–ç‡æŠ¥å‘Š
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-report
          path: htmlcov/
          retention-days: 7

      - name: ç”Ÿæˆè¦†ç›–ç‡æ‘˜è¦
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        run: |
          # æå–è¦†ç›–ç‡ç™¾åˆ†æ¯”
          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); print(f'{float(tree.getroot().attrib[\"line-rate\"]) * 100:.1f}%')" 2>/dev/null || echo "N/A")
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
          echo "### å•å…ƒæµ‹è¯•è¦†ç›–ç‡: $COVERAGE" >> $GITHUB_STEP_SUMMARY

      - name: PR è¦†ç›–ç‡è¯„è®º
        if: github.event_name == 'pull_request' && matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 50

  # E2E æµ‹è¯• (ç«¯åˆ°ç«¯æµ‹è¯•)
  e2e-test:
    runs-on: ubuntu-latest
    needs: test
    # ä»…åœ¨å•å…ƒæµ‹è¯•é€šè¿‡åè¿è¡Œ E2E æµ‹è¯•
    if: success()
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.in
            requirements-test.in

      - name: å®‰è£… pip-tools
        run: python -m pip install --upgrade pip pip-tools

      - name: ä½¿ç”¨ pip-sync å®‰è£…ä¾èµ–
        run: pip-sync requirements.txt

      - name: å®‰è£… pytest-timeout
        run: pip install pytest-timeout

      - name: è¿è¡Œ E2E æµ‹è¯•
        run: |
          echo "## E2E æµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          set +e
          pytest tests/ -v --tb=short --color=yes \
            -m "e2e" \
            --timeout=300 \
            --cov=. --cov-report=xml:coverage-e2e.xml --cov-report=term-missing \
            --cov-fail-under=0 2>&1 | tee e2e_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… **E2E æµ‹è¯•é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
          elif [ $EXIT_CODE -eq 5 ]; then
            echo "âš ï¸ **æ²¡æœ‰æ‰¾åˆ° E2E æµ‹è¯•ç”¨ä¾‹**" >> $GITHUB_STEP_SUMMARY
            exit 0  # æ²¡æœ‰æµ‹è¯•ç”¨ä¾‹ä¸ç®—å¤±è´¥
          else
            echo "âŒ **E2E æµ‹è¯•å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -50 e2e_output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ä¸Šä¼  E2E è¦†ç›–ç‡æŠ¥å‘Š
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage-e2e.xml
          flags: e2e
          name: codecov-e2e
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # é›†æˆæµ‹è¯• (å¯é€‰ï¼Œæ‰‹åŠ¨è§¦å‘)
  integration-test:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[run-integration]')
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip pip-tools
          pip-sync requirements.txt
          pip install pytest-timeout

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: |
          echo "## é›†æˆæµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          set +e
          pytest tests/ -v --tb=short --color=yes \
            -m "integration" \
            --timeout=180 2>&1 | tee integration_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… **é›†æˆæµ‹è¯•é€šè¿‡**" >> $GITHUB_STEP_SUMMARY
          elif [ $EXIT_CODE -eq 5 ]; then
            echo "âš ï¸ **æ²¡æœ‰æ‰¾åˆ°é›†æˆæµ‹è¯•ç”¨ä¾‹**" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âŒ **é›†æˆæµ‹è¯•å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # Python ç¯å¢ƒè®¾ç½® (éµå¾ª reusable-python-setup.yml æ ‡å‡†)
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.in
            requirements-test.in

      - name: å®‰è£… pip-tools å’Œæ£€æŸ¥å·¥å…·
        run: |
          python -m pip install --upgrade pip pip-tools
          pip install flake8 ruff

      - name: flake8 ä¸¥é‡é”™è¯¯æ£€æŸ¥
        run: |
          # åªæ£€æŸ¥ä¸¥é‡é”™è¯¯ (E9, F63, F7, F82)
          flake8 --count --select=E9,F63,F7,F82 --show-source --statistics .

      - name: ruff æ£€æŸ¥
        run: |
          ruff check . --exit-zero
        continue-on-error: true
