# 模块导入检查工作流
# 验证核心 Python 模块可以正确导入，确保依赖完整性
#
# 目标：验证"核心可导入"
# - 仅安装 requirements.txt（核心依赖）
# - 仅检查核心模块（排除 indexing、knowledge 等需要可选 ML 依赖的模块）
# - 确保核心功能在没有可选依赖的情况下可用
#
# 可选依赖模块（indexing、knowledge）需要安装 requirements-optional.txt
# 或使用 pip install -e ".[ml]"，这些在完整测试中验证，不在此 workflow 中

name: Import Test

on:
  push:
    branches:
      - main
      - master
      - 'feature/**'
      - 'fix/**'
  pull_request:
    branches:
      - main
      - master
  workflow_call:
    # 允许被其他工作流调用

jobs:
  import-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            requirements-test.txt

      - name: 安装 pip-tools
        run: python -m pip install --upgrade pip pip-tools

      - name: 安装核心依赖（使用 pip-sync）
        run: |
          # 仅安装核心依赖（requirements.txt）
          # 可选依赖（sentence-transformers, chromadb 等）不在此处安装
          pip-sync requirements.txt

      - name: 运行核心模块导入检查
        id: import-check
        run: |
          # 使用 check_all.sh --mode import 运行导入检查
          # 等效于：语法检查 + 核心模块导入 + 预提交检查
          set +e
          bash scripts/check_all.sh --mode import --ci --json > import-check-result.json 2>&1
          EXIT_CODE=$?
          set -e
          
          # 检查结果
          if [ $EXIT_CODE -eq 0 ]; then
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "所有核心模块导入检查通过"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "核心模块导入检查失败"
          fi
          
          # 显示完整输出
          cat import-check-result.json

      - name: 生成检查报告摘要
        if: always()
        run: |
          echo "## 核心模块导入检查报告 (Python ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> 检查范围：核心模块（排除 indexing、knowledge 等需要可选 ML 依赖的模块）" >> $GITHUB_STEP_SUMMARY
          echo "> 使用命令: \`bash scripts/check_all.sh --mode import --ci\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f import-check-result.json ]; then
            # 解析 check_all.sh --json 输出并生成 Markdown 表格
            python << 'EOF'
          import json
          import os
          
          try:
              with open('import-check-result.json', 'r') as f:
                  data = json.load(f)
              
              summary = []
              
              # 总体状态（check_all.sh --json 输出格式）
              is_success = data.get('success', False)
              passed_count = data.get('summary', {}).get('passed', 0)
              failed_count = data.get('summary', {}).get('failed', 0)
              
              if is_success:
                  summary.append("### ✅ 检查通过\n")
              else:
                  summary.append("### ❌ 检查失败\n")
              
              summary.append(f"- **通过**: {passed_count}")
              summary.append(f"- **失败**: {failed_count}")
              summary.append("")
              
              # 详细结果表格
              summary.append("### 检查详情\n")
              summary.append("| 检查项 | 状态 | 信息 |")
              summary.append("|--------|------|------|")
              
              for check in data.get('checks', []):
                  status_str = check.get('status', 'unknown')
                  if status_str == 'pass':
                      status = "✅"
                  elif status_str == 'fail':
                      status = "❌"
                  elif status_str == 'warn':
                      status = "⚠️"
                  else:
                      status = "ℹ️"
                  name = check.get('name', 'Unknown')
                  message = check.get('message', '')[:80]  # 截断长消息
                  summary.append(f"| {name} | {status} | {message} |")
              
              summary.append("")
              
              # 失败项详情
              failed_checks = [c for c in data.get('checks', []) if c.get('status') == 'fail']
              if failed_checks:
                  summary.append("### 失败详情\n")
                  for check in failed_checks:
                      summary.append(f"#### {check.get('name')}")
                      if check.get('message'):
                          summary.append(f"- {check.get('message')}")
                      if check.get('log_file'):
                          summary.append(f"- 日志: `{check.get('log_file')}`")
                      summary.append("")
              
              # 写入摘要
              with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                  f.write('\n'.join(summary))
                  
          except Exception as e:
              with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                  f.write(f"\n### ⚠️ 无法解析检查结果\n\n错误: {e}\n")
          EOF
          else
            echo "### ⚠️ 检查结果文件不存在" >> $GITHUB_STEP_SUMMARY
          fi

      - name: 上传检查结果
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: import-check-result-py${{ matrix.python-version }}
          path: import-check-result.json
          retention-days: 7

      - name: 检查结果判定
        if: steps.import-check.outputs.status == 'failed'
        run: |
          echo "核心模块导入检查失败，请查看详细报告"
          echo ""
          echo "本地复现命令:"
          echo "  bash scripts/check_all.sh --mode import --ci"
          exit 1
