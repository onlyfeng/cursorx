# 代码质量检查工作流
# 专注于代码风格、类型检查和质量分析
# PR 检查由 pr-check.yml 统一调用本工作流（避免重复运行）
#
# 本地等效命令:
#   bash scripts/check_all.sh --mode lint --ci
#
# check_all.sh --mode lint 包含:
#   - flake8 严重错误检查 (E9, F63, F7, F82)
#   - ruff 代码检查
#   - mypy 类型检查 (core/ 和 agents/)

name: Lint

on:
  push:
    branches:
      - main
      - master
      - 'feature/**'
      - 'fix/**'
  workflow_call:
    # 允许被其他工作流（如 pr-check.yml）调用

jobs:
  # flake8 严重错误检查 - 必须通过
  flake8-critical:
    name: flake8 严重错误
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v6

      # Python 环境设置 (遵循 reusable-python-setup.yml 标准)
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            requirements-test.txt

      - name: 安装依赖（使用 pip-sync）
        run: |
          python -m pip install --upgrade pip pip-tools
          pip-sync requirements.txt requirements-dev.txt

      - name: 检查严重错误 (E9, F63, F7, F82)
        run: |
          # E9: Runtime errors (SyntaxError, IndentationError, etc.)
          # F63: Invalid print function call
          # F7: Syntax errors in type annotations
          # F82: Undefined names
          flake8 --count --select=E9,F63,F7,F82 --show-source --statistics .

  # ruff 快速检查 - 推荐使用
  ruff:
    name: ruff 检查
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v6

      # Python 环境设置 (遵循 reusable-python-setup.yml 标准)
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            requirements-test.txt

      - name: 安装依赖（使用 pip-sync）
        run: |
          python -m pip install --upgrade pip pip-tools
          pip-sync requirements.txt requirements-dev.txt

      - name: ruff 检查
        run: |
          # 使用 ruff 进行快速代码检查
          echo "=== Ruff 检查结果 ==="
          ruff check . --output-format=grouped || true
          
          # 统计问题数量
          ISSUES=$(ruff check . --quiet 2>&1 | wc -l)
          echo ""
          echo "发现 $ISSUES 个问题"
          
          # 严重错误导致失败（与 flake8-critical 保持一致）
          # E9: 运行时错误 (SyntaxError, IndentationError 等)
          # F63: 无效的 print 函数调用
          # F7: 类型注解语法错误
          # F82: 未定义的名称
          # F401 (未使用导入) 只作为警告，不导致失败
          ruff check . --select=E9,F63,F7,F82

  # mypy 类型检查 - 核心模块
  mypy:
    name: mypy 类型检查
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v6

      # Python 环境设置 (遵循 reusable-python-setup.yml 标准)
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            requirements-test.txt

      - name: 安装依赖（使用 pip-sync）
        run: |
          python -m pip install --upgrade pip pip-tools
          pip-sync requirements.txt requirements-dev.txt

      - name: mypy 类型检查 (core/ 和 agents/)
        run: |
          echo "=== mypy 类型检查 ==="
          mypy core/ agents/ \
            --ignore-missing-imports \
            --no-error-summary \
            --show-error-codes \
            --pretty || {
              echo ""
              echo "⚠️ 类型检查有警告，但不影响构建"
              exit 0
            }

  # 代码风格警告 - 可选失败
  style-warnings:
    name: 代码风格警告
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: 检出代码
        uses: actions/checkout@v6

      # Python 环境设置 (遵循 reusable-python-setup.yml 标准)
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            requirements-test.txt

      - name: 安装依赖（使用 pip-sync）
        run: |
          python -m pip install --upgrade pip pip-tools
          pip-sync requirements.txt requirements-dev.txt

      - name: flake8 代码风格检查
        run: |
          echo "=== flake8 代码风格警告 ==="
          # 代码风格检查（不计入失败）
          flake8 --count --exit-zero \
            --max-complexity=10 \
            --max-line-length=120 \
            --statistics . || true
          echo ""
          echo "以上为代码风格建议，不影响构建结果"

      - name: ruff 格式建议
        run: |
          echo "=== ruff 格式建议 ==="
          ruff check . --exit-zero --output-format=grouped || true
          echo ""
          echo "运行 'ruff check . --fix' 可自动修复部分问题"
