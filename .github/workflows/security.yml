name: Security Audit

on:
  # æ¯å‘¨ä¸€ UTC æ—¶é—´ 00:00 è¿è¡Œ
  schedule:
    - cron: '0 0 * * 1'
  # PR è§¦å‘
  pull_request:
    branches: [main]
    paths:
      - 'requirements.txt'
      - 'pyproject.toml'
      - '.github/workflows/security.yml'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit>=2.6.0
          pip install -r requirements.txt

      - name: Run pip-audit
        id: audit
        run: |
          # è¿è¡Œ pip-auditï¼Œé«˜å±åŠä»¥ä¸Šæ¼æ´ä¼šå¯¼è‡´å¤±è´¥
          # --strict: ä»»ä½•æ¼æ´éƒ½è§†ä¸ºé”™è¯¯
          # --desc: æ˜¾ç¤ºæ¼æ´æè¿°
          # --fix: ä»…æ˜¾ç¤ºå¯ä¿®å¤çš„å»ºè®®ï¼ˆä¸è‡ªåŠ¨ä¿®å¤ï¼‰
          pip-audit --strict --desc on 2>&1 | tee audit-results.txt
        continue-on-error: true

      - name: Check audit results
        run: |
          if [ -f audit-results.txt ]; then
            # æ£€æŸ¥æ˜¯å¦å­˜åœ¨é«˜å±æ¼æ´ (High/Critical)
            if grep -iE "(high|critical)" audit-results.txt; then
              echo "::error::å‘ç°é«˜å±æˆ–ä¸¥é‡å®‰å…¨æ¼æ´ï¼"
              exit 1
            fi
            
            # æ£€æŸ¥ pip-audit æ˜¯å¦æŠ¥å‘Šäº†æ¼æ´
            if [ "${{ steps.audit.outcome }}" == "failure" ]; then
              echo "::warning::å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š"
              # å¯¹äºéé«˜å±æ¼æ´ï¼Œä»…è­¦å‘Šä¸å¤±è´¥
              cat audit-results.txt
            fi
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-results
          path: audit-results.txt
          retention-days: 30

      - name: Create issue on vulnerability (optional)
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let auditResults = '';
            try {
              auditResults = fs.readFileSync('audit-results.txt', 'utf8');
            } catch (e) {
              auditResults = 'æ— æ³•è¯»å–å®¡è®¡ç»“æœ';
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„ issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated'
            });
            
            const existingIssue = issues.data.find(
              issue => issue.title.includes('å®‰å…¨æ¼æ´æ£€æµ‹æŠ¥å‘Š')
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ” å®‰å…¨æ¼æ´æ£€æµ‹æŠ¥å‘Š - ' + new Date().toISOString().split('T')[0],
                body: `## ä¾èµ–å®‰å…¨æ‰«æå‘ç°é—®é¢˜\n\nè‡ªåŠ¨åŒ–å®‰å…¨æ‰«æå‘ç°ä»¥ä¸‹æ¼æ´:\n\n\`\`\`\n${auditResults.substring(0, 3000)}\n\`\`\`\n\nè¯·åŠæ—¶å¤„ç†ï¼`,
                labels: ['security', 'automated']
              });
            }
