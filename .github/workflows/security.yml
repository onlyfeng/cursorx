name: Security Audit

on:
  # æ¯å‘¨ä¸€ UTC æ—¶é—´ 00:00 è¿è¡Œ
  schedule:
    - cron: '0 0 * * 1'
  # PR è§¦å‘
  pull_request:
    branches: [main, master]
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # æ£€æµ‹ä¾èµ–æ–‡ä»¶å˜æ›´
  changes:
    runs-on: ubuntu-latest
    outputs:
      deps: ${{ steps.filter.outputs.deps }}
      deps_files: ${{ steps.filter.outputs.deps_files }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æµ‹ä¾èµ–æ–‡ä»¶å˜æ›´
        uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name == 'pull_request'
        with:
          filters: |
            deps:
              - 'requirements*.txt'
              - 'requirements*.in'
              - 'pyproject.toml'
              - 'setup.py'
              - 'setup.cfg'
          list-files: shell

      - name: é PR äº‹ä»¶é»˜è®¤è¿è¡Œ
        if: github.event_name != 'pull_request'
        run: echo "deps=true" >> $GITHUB_OUTPUT

  dependency-audit:
    name: Dependency Security Audit
    needs: changes
    if: needs.changes.outputs.deps == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      pip_check_status: ${{ steps.pip_check.outputs.status }}
      audit_status: ${{ steps.audit.outputs.status }}
      vulnerabilities_found: ${{ steps.audit.outputs.vulnerabilities }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit>=2.6.0
          pip install -r requirements.txt

      - name: Run pip check
        id: pip_check
        run: |
          echo "## pip check ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          set +e
          OUTPUT=$(pip check 2>&1)
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… æ‰€æœ‰ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ä¾èµ–å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "$OUTPUT" > pip-check-results.txt
          fi

      - name: Run pip-audit
        id: audit
        run: |
          echo "## pip-audit å®‰å…¨æ¼æ´æ‰«æ" >> $GITHUB_STEP_SUMMARY
          set +e
          # è¿è¡Œ pip-auditï¼Œé«˜å±åŠä»¥ä¸Šæ¼æ´ä¼šå¯¼è‡´å¤±è´¥
          # --strict: ä»»ä½•æ¼æ´éƒ½è§†ä¸ºé”™è¯¯
          # --desc: æ˜¾ç¤ºæ¼æ´æè¿°
          OUTPUT=$(pip-audit --strict --desc on 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "$OUTPUT" > audit-results.txt
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… æœªå‘ç°å·²çŸ¥å®‰å…¨æ¼æ´" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
            echo "vulnerabilities=0" >> $GITHUB_OUTPUT
          else
            # ç»Ÿè®¡æ¼æ´æ•°é‡
            VULN_COUNT=$(echo "$OUTPUT" | grep -cE "^Name:" || echo "0")
            echo "vulnerabilities=$VULN_COUNT" >> $GITHUB_OUTPUT
            
            # æ£€æŸ¥æ˜¯å¦å­˜åœ¨é«˜å±æ¼æ´
            if echo "$OUTPUT" | grep -iE "(high|critical)"; then
              echo "â›” å‘ç°é«˜å±/ä¸¥é‡å®‰å…¨æ¼æ´ï¼" >> $GITHUB_STEP_SUMMARY
              echo "status=critical" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ å‘ç°æ½œåœ¨å®‰å…¨é—®é¢˜" >> $GITHUB_STEP_SUMMARY
              echo "status=warning" >> $GITHUB_OUTPUT
            fi
            
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Check audit results
        run: |
          if [ -f audit-results.txt ]; then
            # æ£€æŸ¥æ˜¯å¦å­˜åœ¨é«˜å±æ¼æ´ (High/Critical)
            if grep -iE "(high|critical)" audit-results.txt; then
              echo "::error::å‘ç°é«˜å±æˆ–ä¸¥é‡å®‰å…¨æ¼æ´ï¼"
              exit 1
            fi
            
            # æ£€æŸ¥ pip-audit æ˜¯å¦æŠ¥å‘Šäº†æ¼æ´
            if [ "${{ steps.audit.outputs.status }}" == "warning" ]; then
              echo "::warning::å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š"
              # å¯¹äºéé«˜å±æ¼æ´ï¼Œä»…è­¦å‘Šä¸å¤±è´¥
              cat audit-results.txt
            fi
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-results
          path: |
            audit-results.txt
            pip-check-results.txt
          retention-days: 30

      - name: Create issue on vulnerability (optional)
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let auditResults = '';
            try {
              auditResults = fs.readFileSync('audit-results.txt', 'utf8');
            } catch (e) {
              auditResults = 'æ— æ³•è¯»å–å®¡è®¡ç»“æœ';
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç›¸åŒçš„ issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated'
            });
            
            const existingIssue = issues.data.find(
              issue => issue.title.includes('å®‰å…¨æ¼æ´æ£€æµ‹æŠ¥å‘Š')
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ” å®‰å…¨æ¼æ´æ£€æµ‹æŠ¥å‘Š - ' + new Date().toISOString().split('T')[0],
                body: `## ä¾èµ–å®‰å…¨æ‰«æå‘ç°é—®é¢˜\n\nè‡ªåŠ¨åŒ–å®‰å…¨æ‰«æå‘ç°ä»¥ä¸‹æ¼æ´:\n\n\`\`\`\n${auditResults.substring(0, 3000)}\n\`\`\`\n\nè¯·åŠæ—¶å¤„ç†ï¼`,
                labels: ['security', 'automated']
              });
            }

  # PR å®‰å…¨æ£€æŸ¥è¯„è®º
  security-comment:
    name: PR Security Comment
    needs: [changes, dependency-audit]
    if: github.event_name == 'pull_request' && needs.changes.outputs.deps == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: å‘è¡¨å®‰å…¨æ£€æŸ¥è¯„è®º
        uses: actions/github-script@v8
        with:
          script: |
            const pipCheckStatus = '${{ needs.dependency-audit.outputs.pip_check_status }}';
            const auditStatus = '${{ needs.dependency-audit.outputs.audit_status }}';
            const vulnCount = '${{ needs.dependency-audit.outputs.vulnerabilities_found }}';
            
            const statusIcon = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'warning') return 'âš ï¸';
              if (status === 'critical') return 'â›”';
              return 'âŒ';
            };
            
            const statusText = (status) => {
              if (status === 'success') return 'é€šè¿‡';
              if (status === 'warning') return 'è­¦å‘Š';
              if (status === 'critical') return 'ä¸¥é‡';
              return 'å¤±è´¥';
            };
            
            let body = `## ğŸ” ä¾èµ–å®‰å…¨æ£€æŸ¥æŠ¥å‘Š
            
            æ£€æµ‹åˆ°ä¾èµ–æ–‡ä»¶å˜æ›´ï¼Œå·²æ‰§è¡Œå®‰å…¨å®¡è®¡ï¼š
            
            | æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
            |--------|------|------|
            | pip check | ${statusIcon(pipCheckStatus)} ${statusText(pipCheckStatus)} | ä¾èµ–å®Œæ•´æ€§éªŒè¯ |
            | pip-audit | ${statusIcon(auditStatus)} ${statusText(auditStatus)} | å·²çŸ¥æ¼æ´æ‰«æ |
            `;
            
            if (vulnCount && vulnCount !== '0') {
              body += `\n### âš ï¸ å‘ç° ${vulnCount} ä¸ªæ½œåœ¨å®‰å…¨é—®é¢˜\n`;
              body += `è¯·æŸ¥çœ‹ workflow æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚\n`;
            }
            
            body += `\n> è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ [Security Audit è¿è¡Œæ—¥å¿—](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
            
            // æŸ¥æ‰¾å·²æœ‰è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ” ä¾èµ–å®‰å…¨æ£€æŸ¥æŠ¥å‘Š')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
