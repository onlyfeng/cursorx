# Cursor CLI 修复 CI 失败工作流
# 参考: https://cursor.com/cn/docs/cli/cookbook/fix-ci
#
# 当 CI 构建失败时自动尝试修复

name: 修复 CI 失败

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches-ignore:
      - main
      - master

# 并发控制：同一分支只运行一个修复任务
concurrency:
  group: fix-ci-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  fix-ci:
    runs-on: ubuntu-latest
    # 仅在 CI 失败时运行，且排除 main/master 分支
    if: >-
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch != 'main' &&
      github.event.workflow_run.head_branch != 'master'

    steps:
      - name: 检出代码
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.in
            requirements-test.in

      - name: 安装 pip-tools 和项目依赖
        run: |
          pip install --upgrade pip pip-tools
          # 使用 pip-sync 确保环境与 requirements.txt 完全一致
          pip-sync requirements.txt

      - name: 验证依赖安装
        run: |
          pip check
          python -c "import pydantic; import loguru; print('依赖验证通过')"

      - name: 安装 Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: 配置 git
        run: |
          git config user.name "Cursor Agent"
          git config user.email "cursoragent@cursor.com"

      - name: 获取失败日志
        id: get-logs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取失败的工作流运行日志
          gh run view ${{ github.event.workflow_run.id }} --log-failed > /tmp/ci-failure.log 2>&1 || true
          echo "logs_file=/tmp/ci-failure.log" >> $GITHUB_OUTPUT

      - name: 分析并修复问题
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 从项目 config.yaml 读取默认 Worker 模型，确保单一配置点
          WORKER_MODEL=$(python -c "from core.config import get_config; print(get_config().models.worker)")
          agent --force --model "$WORKER_MODEL" --output-format=text --print "
          CI 构建失败。请分析失败日志并尝试修复问题。

          失败日志位于: ${{ steps.get-logs.outputs.logs_file }}
          分支: ${{ github.event.workflow_run.head_branch }}

          请执行以下步骤:
          1. 读取失败日志，理解失败原因
          2. 分析相关代码文件
          3. 进行必要的修复
          4. 验证修复是否解决了问题

          注意:
          - 只修复导致 CI 失败的问题
          - 不要进行不相关的改动
          - 如果无法确定问题，请说明原因
          "

      - name: 检查是否有变更
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: 提交修复
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git add -A
          git commit -m "fix: 自动修复 CI 失败

          由 Cursor Agent 自动生成的修复。

          原始失败运行: ${{ github.event.workflow_run.html_url }}"
          git push origin ${{ github.event.workflow_run.head_branch }}
