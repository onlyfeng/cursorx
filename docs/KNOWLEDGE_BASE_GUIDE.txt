================================================================================
                        知识库使用指南
================================================================================

本文档介绍如何测试、使用和验证知识库功能。

================================================================================
目录
================================================================================

1. 快速开始
2. 添加文档
3. 搜索查询
4. 验证测试
5. 交互式测试
6. 常见问题

================================================================================
1. 快速开始
================================================================================

1.1 检查依赖
-----------
确保已安装必要依赖：
    pip install -r requirements.txt

核心依赖：
    - pydantic
    - loguru
    - beautifulsoup4
    - aiofiles

可选依赖（用于向量搜索）：
    - sentence-transformers
    - chromadb

1.2 验证安装
-----------
运行快速验证：
    PYTHONPATH=. python tests/test_knowledge_validation.py

或使用脚本：
    bash scripts/validate_knowledge.sh

1.3 交互式演示
-----------
体验知识库功能：
    PYTHONPATH=. python scripts/test_knowledge_interactive.py --demo


================================================================================
2. 添加文档
================================================================================

2.1 添加单个 URL
---------------
    python scripts/knowledge_cli.py add https://example.com

2.2 添加本地文件
---------------
支持格式：.txt, .md, .rst, .markdown

    python scripts/knowledge_cli.py add-file ./docs/readme.md
    python scripts/knowledge_cli.py add-file ./notes.txt --encoding utf-8

2.3 批量导入 URL
---------------
创建 urls.txt 文件，每行一个 URL：
    https://example.com/page1
    https://example.com/page2
    # 以 # 开头的行会被忽略

导入：
    python scripts/knowledge_cli.py import urls.txt

2.4 查看已添加文档
-----------------
    python scripts/knowledge_cli.py list
    python scripts/knowledge_cli.py list -v  # 详细信息

2.5 删除文档
-----------
    python scripts/knowledge_cli.py remove <doc_id>

2.6 刷新文档
-----------
重新获取 URL 内容：
    python scripts/knowledge_cli.py refresh <doc_id>
    python scripts/knowledge_cli.py refresh --all


================================================================================
3. 搜索查询
================================================================================

3.1 关键词搜索
-------------
    python scripts/knowledge_cli.py search "Python 编程"

3.2 语义搜索（需要 sentence-transformers）
-----------------------------------------
    python scripts/knowledge_cli.py search --mode semantic "机器学习"
    python scripts/knowledge_cli.py search --mode semantic --min-score 0.5 "API 设计"

3.3 混合搜索
-----------
结合关键词和语义搜索：
    python scripts/knowledge_cli.py search --mode hybrid "Docker 容器"
    python scripts/knowledge_cli.py search --mode hybrid --semantic-weight 0.8 "REST API"

3.4 搜索参数
-----------
    --mode         搜索模式: keyword(默认), semantic, hybrid
    --top-k        返回结果数量（默认 10）
    --min-score    最低相似度阈值（0.0-1.0）
    --semantic-weight  混合搜索中语义权重（0.0-1.0，默认 0.7）


================================================================================
4. 验证测试
================================================================================

4.1 快速验证
-----------
验证知识库核心功能是否正常：
    bash scripts/validate_knowledge.sh

输出示例：
    ✓ 模块导入正常
    ✓ KnowledgeManager 初始化成功
    ✓ 文档添加成功
    ✓ 关键词搜索成功
    ✓ 文档分块成功
    ✓ 向量配置正常
    ✓ 存储功能正常
    ✓ 清理功能正常

4.2 完整测试
-----------
运行所有单元测试（138 个）：
    bash scripts/validate_knowledge.sh --full

或使用 pytest：
    PYTHONPATH=. pytest tests/test_knowledge.py tests/test_knowledge_vector.py tests/test_knowledge_validation.py -v

4.3 自动测试模式
---------------
运行自动化测试并生成报告：
    PYTHONPATH=. python scripts/test_knowledge_interactive.py --auto

输出包括：
    - 文档存储测试
    - 关键词搜索测试
    - 搜索准确性测试
    - 文档分块测试
    - 测试结果摘要

4.4 向量索引验证
---------------
检查向量索引状态：
    python scripts/knowledge_cli.py index stats

构建向量索引：
    python scripts/knowledge_cli.py index build

重建向量索引：
    python scripts/knowledge_cli.py index rebuild


================================================================================
5. 交互式测试
================================================================================

5.1 演示模式
-----------
使用演示数据体验查询效果：
    PYTHONPATH=. python scripts/test_knowledge_interactive.py --demo

演示数据包含：
    - Python 编程入门指南
    - 机器学习基础概念
    - RESTful API 设计规范
    - Docker 容器技术
    - Git 版本控制指南

5.2 交互查询模式
---------------
启动交互式查询：
    PYTHONPATH=. python scripts/test_knowledge_interactive.py

然后输入问题进行查询：
    问题> Python 有什么特点？
    问题> 如何创建 Docker 镜像？
    问题> q  # 退出

5.3 直接查询
-----------
单次查询：
    PYTHONPATH=. python scripts/test_knowledge_interactive.py --query "什么是机器学习？"

5.4 使用真实存储
---------------
查询项目真实知识库（而非演示数据）：
    PYTHONPATH=. python scripts/test_knowledge_interactive.py --real
    PYTHONPATH=. python scripts/test_knowledge_interactive.py --real --query "问题"


================================================================================
6. 常见问题
================================================================================

Q1: 模块导入失败 "No module named 'knowledge'"
A1: 设置 PYTHONPATH：
    export PYTHONPATH=/path/to/project
    # 或在命令前加上
    PYTHONPATH=. python ...

Q2: 向量搜索不工作
A2: 安装可选依赖：
    pip install sentence-transformers chromadb

Q3: 搜索结果不准确
A3:
    - 尝试使用不同的搜索模式（semantic, hybrid）
    - 调整 --min-score 参数
    - 确保文档内容足够丰富

Q4: 如何查看知识库统计
A4:
    python scripts/knowledge_cli.py stats

Q5: 如何清空知识库
A5: 逐个删除文档，或删除存储目录：
    rm -rf .cursor/knowledge/

Q6: 添加 URL 失败
A6:
    - 检查 URL 是否有效
    - 确保网络连接正常
    - 某些网站可能需要特殊处理


================================================================================
完整命令参考
================================================================================

知识库管理 CLI：
    python scripts/knowledge_cli.py add <url>              # 添加 URL
    python scripts/knowledge_cli.py add-file <file>        # 添加文件
    python scripts/knowledge_cli.py import <urls.txt>      # 批量导入
    python scripts/knowledge_cli.py list                   # 列出文档
    python scripts/knowledge_cli.py search <query>         # 搜索
    python scripts/knowledge_cli.py remove <doc_id>        # 删除
    python scripts/knowledge_cli.py refresh <doc_id>       # 刷新
    python scripts/knowledge_cli.py stats                  # 统计信息
    python scripts/knowledge_cli.py index build            # 构建索引
    python scripts/knowledge_cli.py index rebuild          # 重建索引
    python scripts/knowledge_cli.py index stats            # 索引状态

验证脚本：
    bash scripts/validate_knowledge.sh                     # 快速验证
    bash scripts/validate_knowledge.sh --full              # 完整测试
    bash scripts/validate_knowledge.sh --validation        # 验证模块
    bash scripts/validate_knowledge.sh --vector            # 向量测试

交互式测试：
    python scripts/test_knowledge_interactive.py           # 交互模式
    python scripts/test_knowledge_interactive.py --auto    # 自动测试
    python scripts/test_knowledge_interactive.py --demo    # 演示模式
    python scripts/test_knowledge_interactive.py --query   # 直接查询
    python scripts/test_knowledge_interactive.py --real    # 真实存储


================================================================================
7. Cursor CLI 知识库集成
================================================================================

7.1 更新 Cursor CLI 知识库
-------------------------
从本地文档更新：
    PYTHONPATH=. python scripts/test_cursor_knowledge.py update

从网页 URL 更新（需要网络）：
    PYTHONPATH=. python scripts/test_cursor_knowledge.py update --url

7.2 验证知识库
-------------
验证知识库内容是否正确：
    PYTHONPATH=. python scripts/test_cursor_knowledge.py verify

7.3 Agent 查询测试
-----------------
运行完整测试（更新 + 验证 + Agent 查询）：
    PYTHONPATH=. python scripts/test_cursor_knowledge.py test

7.4 交互式查询
-------------
启动交互式查询模式：
    PYTHONPATH=. python scripts/test_cursor_knowledge.py interactive

7.5 直接查询
-----------
单次查询：
    PYTHONPATH=. python scripts/test_cursor_knowledge.py query "CLI 参数"
    PYTHONPATH=. python scripts/test_cursor_knowledge.py query "斜杠命令"
    PYTHONPATH=. python scripts/test_cursor_knowledge.py query "MCP 服务器"

7.6 测试查询示例
---------------
以下查询可用于验证知识库：

    # 查询 CLI 命令行参数
    python scripts/test_cursor_knowledge.py query "CLI 参数"

    # 查询斜杠命令
    python scripts/test_cursor_knowledge.py query "斜杠命令"

    # 查询模型列表
    python scripts/test_cursor_knowledge.py query "模型"

    # 查询认证方法
    python scripts/test_cursor_knowledge.py query "登录 认证"

7.7 知识库内容来源
-----------------
知识库从以下来源获取信息：
    - cursor_cli_docs.txt: CLI 文档 URL 列表
    - cursor_agent_docs.txt: Agent 文档 URL 列表
    - cursor_docs_full.txt: 完整文档列表
    - AGENTS.md: Agent 系统规则（包含详细命令说明）


================================================================================
                              文档结束
================================================================================
