# 规划者-执行者 多Agent系统 配置文件
#
# 配置优先级（高到低）:
#   1. CLI 参数        (--workers, --execution-mode 等)
#   2. 环境变量        (CURSOR_API_KEY, CURSOR_CLOUD_API_KEY 等)
#   3. config.yaml    (本文件)
#   4. DEFAULT_* 常量  (代码中的默认值)
#
# 例如: --workers 5 会覆盖本文件中的 worker_pool_size: 3

# 系统配置
# 以下配置可被 CLI 参数覆盖
system:
  max_iterations: 10        # 最大迭代次数，CLI: --max-iterations
  worker_pool_size: 3       # Worker 池大小，CLI: --workers
  enable_sub_planners: true # 是否启用子规划者
  strict_review: false      # 严格评审模式

# 模型配置 - 不同 Agent 使用不同模型
# 适用于: 基本模式 (run.py) 和 多进程模式 (run_mp.py)
# 使用 `agent models` 查看完整可用模型列表
models:
  # 规划者模型 - GPT 5.2 High 擅长高层规划和任务分解
  planner: gpt-5.2-high

  # 执行者模型 - Claude 4.5 Opus (Thinking) 擅长代码生成
  worker: opus-4.5-thinking

  # 评审者模型 - GPT 5.2 Codex 擅长代码审查
  reviewer: gpt-5.2-codex

# 可用模型列表 (2026-01):
# - gpt-5.2-high      : GPT-5.2 High
# - gpt-5.2           : GPT-5.2
# - gpt-5.2-codex     : GPT-5.2 Codex
# - opus-4.5-thinking : Claude 4.5 Opus (Thinking) [默认]
# - opus-4.5          : Claude 4.5 Opus
# - sonnet-4.5-thinking: Claude 4.5 Sonnet (Thinking)
# - sonnet-4.5        : Claude 4.5 Sonnet
# - gemini-3-pro      : Gemini 3 Pro
# - gemini-3-flash    : Gemini 3 Flash
# - grok              : Grok

# agent CLI 配置
# 安装: curl https://cursor.com/install -fsS | bash
# 身份验证: export CURSOR_API_KEY=your_api_key_here
# API Key 优先级: CLI(-a/--api-key) > 环境变量(CURSOR_API_KEY) > config.yaml
agent_cli:
  path: agent               # agent CLI 路径（可被 CLI 参数覆盖）
  timeout: 300              # 本地 CLI 超时时间（秒），用于本地执行模式
  max_retries: 3            # 最大重试次数
  output_format: text       # 输出格式: text, json, stream-json（CLI: --output-format）
  # api_key: ""             # API 密钥（优先级最低，推荐使用环境变量）

# Cloud Agent 配置
# 提供云端 API 访问能力，支持程序化调用 Cursor Agent
# 执行模式（CLI: --execution-mode）:
#   - cli:   使用本地 agent CLI 执行（需要安装 cursor CLI）
#   - cloud: 使用 Cloud API 执行（需要 API 密钥）
#   - auto:  自动选择（优先使用 cloud，失败时降级到 cli）
# 优先级: CLI(--execution-mode) > 环境变量 > config.yaml > CloudAgentConfig.execution_mode 默认值 ("auto")
#
# ⚠ 编排器兼容性说明:
#   - execution_mode=cloud 或 auto 时，系统会**强制使用 basic 编排器**
#   - MP 编排器（MultiProcessOrchestrator）仅在 execution_mode=cli/plan/ask 时可用
#   - 推荐命令: python scripts/run_iterate.py "任务"  # 默认 auto + 自动 basic 编排器
#   - 显式指定: python scripts/run_iterate.py --execution-mode cli --orchestrator mp "任务"  # 使用本地 CLI + MP 编排器
cloud_agent:
  # 是否启用 Cloud Agent
  # 作用范围: 控制 `&` 前缀自动路由是否生效
  #   - enabled=true:  输入以 `&` 开头时自动触发 Cloud 模式（如 "& 分析代码"）
  #   - enabled=false: `&` 前缀不会触发 Cloud 模式，任务使用本地 CLI 执行
  # 注意: 即使 enabled=false，显式指定 --execution-mode cloud/auto 仍可使用 Cloud
  # 触发条件: enabled=true + has_api_key + 输入以 `&` 开头
  enabled: true

  # 是否自动检测 `&` 前缀作为 Cloud 意图
  # 仅控制 `&` 前缀是否被视为 Cloud 意图（影响 prefix_routed 与编排器选择）
  # 不替代 cloud_agent.enabled（控制 Cloud 功能开关）和 execution_mode（控制执行模式选择）
  #
  # 取值说明:
  #   - true（默认）: `&` 前缀触发 Cloud 意图检测，影响 prefix_routed 和编排器选择
  #   - false: `&` 前缀被忽略，不触发 Cloud 意图检测
  #
  # 与 R-2/R-3 规则的关系:
  #   - R-2: 当 auto_detect_cloud_prefix=true 时，& 前缀即表达 Cloud 意图；
  #          即使因缺少 API Key 或 cloud_agent.enabled=false 未成功路由，编排器仍强制 basic
  #   - R-3: 当 auto_detect_cloud_prefix=false 或显式 --execution-mode cli 时，
  #          & 前缀被忽略，编排器可使用 mp
  #
  # CLI 参数（tri-state，优先级高于本配置）:
  #   --auto-detect-cloud-prefix      显式启用（覆盖本配置）
  #   --no-auto-detect-cloud-prefix   显式禁用（覆盖本配置）
  #   未指定时使用本配置的值
  auto_detect_cloud_prefix: true

  # 执行模式: cli | cloud | auto（CLI: --execution-mode）
  # auto 模式下无 Cloud API Key 时会自动回退到 CLI（仍保持 auto 语义）
  # ⚠ 重要: cloud/auto 模式强制使用 basic 编排器，不支持 MP 多进程编排
  # 默认 auto：优先使用 Cloud，不可用时自动回退到本地 CLI
  execution_mode: auto

  # Cloud API 配置
  # API Key 优先级: CLI(--cloud-api-key) > CURSOR_API_KEY > CURSOR_CLOUD_API_KEY > config.yaml
  # 注意: CURSOR_API_KEY 优先于 CURSOR_CLOUD_API_KEY（后者为备选）
  api_base_url: "https://api.cursor.com"      # API 基础 URL
  # api_key: ""                               # API 密钥（优先级最低，推荐使用环境变量）
  timeout: 300                                # Cloud 请求超时（秒），CLI: --cloud-timeout
  auth_timeout: 30                            # Cloud 认证超时（秒），CLI: --cloud-auth-timeout
  max_retries: 3                              # 最大重试次数

  # 出口 IP 验证配置（用于验证请求来源）
  egress_ip_cache_ttl: 3600                   # 出口 IP 缓存有效期（秒），默认 1 小时
  egress_ip_api_url: ""                       # 自定义 IP 范围 API URL（可选，留空使用默认）
  verify_egress_ip: false                     # 是否验证出口 IP

  # Cloud 冷却策略配置
  # 控制 Cloud API 失败后的冷却时间，按错误类型自适应
  cooldown:
    # RateLimitError（429）冷却配置
    # 使用 retry_after 响应头，夹逼在 [min, max] 区间
    rate_limit_min_seconds: 30                # 最小冷却时间（秒）
    rate_limit_default_seconds: 60            # 默认冷却时间（无 retry_after 时使用）
    rate_limit_max_seconds: 300               # 最大冷却时间（秒）

    # AuthError/NO_KEY 冷却配置
    auth_cooldown_seconds: 600                # 认证失败冷却时间（秒），默认 10 分钟
    auth_require_config_change: true          # 是否需要配置变化才能提前结束冷却

    # Network/Timeout 冷却配置
    network_cooldown_seconds: 120             # 网络错误冷却时间（秒），默认 2 分钟
    timeout_cooldown_seconds: 60              # 超时错误冷却时间（秒），默认 1 分钟

    # Unknown 冷却配置
    unknown_cooldown_seconds: 300             # 未知错误冷却时间（秒），默认 5 分钟

# 网络配置
# 代理和 SSL 设置，影响所有外部网络请求
network:
  proxy_url: ""                               # HTTP/HTTPS 代理 URL（如 http://proxy.example.com:8080）
  ssl_verify: true                            # 是否验证 SSL 证书（生产环境建议保持 true）

# 规划者配置
planner:
  max_sub_planners: 3       # 最大子规划者数量
  max_tasks_per_plan: 10    # 单次规划最大任务数
  exploration_depth: 3      # 探索深度
  timeout: 500              # 规划超时（秒）

# 执行者配置
worker:
  task_timeout: 600         # 任务超时时间（秒）
  max_concurrent_tasks: 1   # 同时处理的任务数

  # Worker 进程内知识库集成（可选）
  # 启用后，Worker 会在处理任务时自动搜索知识库并注入相关文档
  knowledge_integration:
    enabled: false                              # 是否启用知识库集成
    search_mode: keyword                        # 搜索模式: keyword, semantic, hybrid
    max_docs: 3                                 # 每任务最大注入文档数
    min_score: 0.3                              # 最低相关度阈值
    storage_path: .cursor/knowledge             # 知识库存储路径
    enable_vector_index: false                  # 是否启用向量索引（语义搜索需要）
    log_stats: true                             # 是否记录统计数据（检索耗时、payload 大小）

# 评审者配置
reviewer:
  strict_mode: false        # 严格模式
  timeout: 300              # 评审超时（秒）

# 索引配置 - 语义搜索支持
indexing:
  enabled: true                              # 是否启用语义索引
  model: all-MiniLM-L6-v2                    # 嵌入模型（本地 sentence-transformers）
  persist_path: .cursor/vector_index/        # 向量索引持久化路径
  chunk_size: 500                            # 分块大小（字符数）
  chunk_overlap: 50                          # 分块重叠
  # 文件过滤
  include_patterns:
    - "**/*.py"
    - "**/*.js"
    - "**/*.ts"
    - "**/*.go"
    - "**/*.rs"
  exclude_patterns:
    - "**/node_modules/**"
    - "**/.git/**"
    - "**/venv/**"
    - "**/__pycache__/**"
    - "**/dist/**"
    - "**/build/**"
  # 搜索选项
  search:
    top_k: 10                                # 默认返回结果数
    min_score: 0.3                           # 最低相似度阈值
    include_context: true                    # 是否包含上下文
    context_lines: 3                         # 上下文行数

# 日志配置
logging:
  level: INFO               # 日志级别: DEBUG, INFO, WARNING, ERROR
  file: logs/agent.log      # 日志文件
  rotation: 10 MB           # 日志轮转大小
  retention: 7 days         # 日志保留时间
  stream_json:
    enabled: false          # 是否启用 stream-json 流式日志
    console: true           # 是否输出到控制台
    detail_dir: logs/stream_json/detail/  # 详细日志目录
    raw_dir: logs/stream_json/raw/        # 原始 NDJSON 目录

# 知识库文档更新配置
# 控制自我迭代（run_iterate.py）时的文档获取策略
# CLI 参数可覆盖以下配置
# 术语说明参见 knowledge/doc_url_strategy.py 模块契约的【术语表】
knowledge_docs_update:
  docs_source:
    max_fetch_urls: 20                              # 单次更新最多抓取的 URL 数量，CLI: --max-fetch-urls
    fallback_core_docs_count: 5                     # 回退核心文档数量，CLI: --fallback-core-docs-count
    llms_txt_url: "https://cursor.com/llms.txt"     # llms.txt 在线来源，CLI: --llms-txt-url
    llms_cache_path: ".cursor/cache/llms.txt"       # llms.txt 本地缓存路径，CLI: --llms-cache-path
    changelog_url: "https://cursor.com/cn/changelog"  # Changelog URL，CLI: --changelog-url

    # 允许的文档 URL 前缀（完整 URL 前缀格式）
    # 用于 load_core_docs 过滤核心文档 URL
    # CLI: --allowed-doc-url-prefixes（逗号分隔）
    allowed_doc_url_prefixes:
      - "https://cursor.com/cn/docs"
      - "https://cursor.com/docs"
      - "https://cursor.com/cn/changelog"
      - "https://cursor.com/changelog"

    # ============================================================
    # 在线抓取策略配置 (fetch_policy)
    # ============================================================
    # 控制哪些 URL **可以被抓取**（网络请求层面）
    # 与 url_strategy 不同：
    # - fetch_policy: 决定是否发起抓取请求
    # - url_strategy: 决定如何过滤/排序/选择 URL
    # 术语说明参见 knowledge/doc_url_strategy.py 模块契约的【术语表】
    #
    # **当前作用范围**：
    # - 配置已解析并在 update_from_analysis() 主流程中实际调用
    # - 外链过滤（external_link_mode）已生效
    # - 内链路径检查（enforce_path_prefixes）默认禁用，可通过 CLI 启用
    # - 详见 knowledge/doc_url_strategy.py 【fetch_policy 作用范围说明】
    fetch_policy:
      # 允许抓取的 URL **路径前缀**列表
      # 格式：路径前缀（不含 scheme/host），如 "docs", "cn/docs"
      # 仅抓取以这些前缀开头的页面路径
      # 示例: ["docs", "cn/docs"] 表示只抓取 /docs/* 和 /cn/docs/* 路径
      # 注意：与 url_strategy.allowed_url_prefixes（完整 URL 前缀，含域名）格式不同
      # CLI: --allowed-path-prefixes（逗号分隔）
      # [DEPRECATED] 旧字段名 allowed_url_prefixes 仅作为兼容别名保留，请勿使用
      allowed_path_prefixes:
        - "docs"
        - "cn/docs"
        - "changelog"
        - "cn/changelog"

      # **域名白名单**（可选）
      # 空列表表示仅允许主域名（如配置的 llms_txt_url 和 changelog_url 的域名）
      # 支持子域名匹配，如 "cursor.com" 可匹配 api.cursor.com
      # 示例: ["cursor.com", "docs.cursor.com"]
      # CLI: --allowed-domains（逗号分隔）
      allowed_domains: []

      # **外链处理模式**
      # - record_only: 仅记录外链，不抓取（默认，最小抓取面）
      # - skip_all: 完全跳过外链，不记录也不抓取
      # - fetch_allowlist: 仅抓取白名单内的外链
      # CLI: --external-link-mode
      external_link_mode: "record_only"

      # 外链允许白名单（可选）
      # 仅在 external_link_mode="fetch_allowlist" 时生效
      # 示例: ["github.com/cursor", "docs.example.com"]
      # CLI: --external-link-allowlist（逗号分隔）
      external_link_allowlist: []

  # ============================================================
  # URL 选择策略配置 (url_strategy)
  # ============================================================
  # 控制如何**过滤/排序/选择** URL（数据处理层面）
  # 处理流程: 发现 URL → 过滤 → 规范化 → 去重 → 优先级排序 → 截取
  # 与 fetch_policy 不同：url_strategy 处理已获取的 URL，fetch_policy 决定是否获取
  # 术语说明参见 knowledge/doc_url_strategy.py 模块契约的【术语表】
  url_strategy:
    # **域名白名单**
    # 只有匹配这些域名的 URL 才会被处理
    # 支持子域名匹配，如 "cursor.com" 可匹配 api.cursor.com
    # 示例: ["cursor.com", "docs.cursor.com"]
    # CLI: --url-allowed-domains（逗号分隔）
    allowed_domains:
      - "cursor.com"

    # 允许的**完整 URL 前缀**列表（可选）
    # 空列表表示不限制（回退到 allowed_domains 过滤）
    # **格式要求：必须包含 scheme/host（完整 URL 前缀）**
    # 正确示例: ["https://cursor.com/docs", "https://cursor.com/cn/docs"]
    # 错误示例: ["docs", "cn/docs"]（旧版路径前缀格式，已废弃）
    # 注意：与 fetch_policy.allowed_path_prefixes（路径前缀，不含域名）格式不同！
    # CLI: --url-allowed-prefixes（逗号分隔）
    # allowed_url_prefixes: []

    # URL **过滤**排除模式列表（正则表达式）
    # 匹配这些模式的 URL 将被排除
    # 示例: [".*\\.pdf$", ".*#.*", ".*/archive/.*"]
    # CLI: --url-exclude-patterns（逗号分隔）
    exclude_patterns:
      - ".*\\.pdf$"
      - ".*\\.zip$"
      - ".*\\.(png|jpg|jpeg|gif|svg|ico)$"
      - ".*\\.(css|js|woff|woff2|ttf|eot)$"  # 静态资源文件
      - ".*/api/.*"  # API 端点路径

    # URL **选择**时是否优先处理 Changelog 文档
    # 启用后，Changelog 相关文档的优先级会被提升
    # CLI: --prefer-changelog
    prefer_changelog: true

    # 是否启用 URL **去重**
    # 启用后，相同内容的不同 URL 变体会被合并（基于规范化后的结果）
    # 示例: 带/不带尾部斜杠、带/不带 www 前缀
    # CLI: --url-deduplicate / --no-url-deduplicate
    deduplicate: true

    # 是否启用 URL **规范化**
    # 启用后，URL 会被规范化处理（移除锚点、统一斜杠、scheme/host 小写化）
    # CLI: --url-normalize / --no-url-normalize
    normalize: true

    # 关键词匹配权重增益
    # 当文档 URL 包含搜索关键词时的权重提升系数
    # 范围: 0.0 - 2.0（1.0 表示无增益，2.0 表示双倍权重）
    # CLI: --keyword-boost-weight
    keyword_boost_weight: 1.2

    # 语言路径偏好
    # 指定优先匹配的语言路径前缀
    # 示例: ["cn", "zh-CN", "en"]，空列表表示无偏好
    # CLI: --lang-path-preference（逗号分隔）
    lang_path_preference:
      - "cn"

    # 最大重定向跟随次数
    # 防止无限重定向循环
    # CLI: --max-redirects
    max_redirects: 5
